#!/usr/bin/bash
# File: auto_conf_{{ .chezmoi.osRelease.id }}.sh
# Author: {{ .name }}
# Last modified: UTC+8 2021-12-13 10:07

# Thanks: Ayatale, vps2arch.

# HACK: Maybe you need install ucode, firmware, graphics driver.
# PS: Shell is shit. fuck you shell.

# 偏好设置：
# ps：_USER_NAME      如果启用将会创建特权用户（如果用户名不合规，则不会继续创建用户）
# ps：_USER_PASSWORD  如果启用将会给特权用户创建账户密码.（如果用户名不存在，则不会继续创建密码）
# ps：_ROOT_PASSWORD  如果启用将会给 root 用户创建账户密码
# ps：_PASSWORD_LOGIN 如果值是 ENABLE 则允许密码登入，如果值是 DISABLE 则不允许密码登入。
# ps：_SSH_PUBKEY     如果被启用则会允许通过此密钥登入特权用户和 root 用户。

_TIMEZONE=Asia/Shanghai
_LANG=en_SG.UTF-8
_SHELL=zsh
_EDITOR=nano
_HOSTNAME=Netech
_DNS_SERVER_M=8.8.8.8
_DNS_SERVER_B=8.8.4.4
_DNS_OVER_HTTPS='https://i.passcloud.xyz/dns-query'

#_USER_NAME={{ .chezmoi.username }}
#_USER_PASSWORD=password
#_ROOT_PASSWORD=password
_PASSWORD_LOGIN=DISABLE
_SSH_PUBKEY='ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDCv96Mn19WYF6klxlagKycBkJLRzscs1Ho4WnQltNLDJQJR1PjxFOX3W2UBB6wvsavUe+0HWPFeOCvHajwvYlqPBdsfuA+HPk/x+tTXtBTAS5we4eCm67wYc61T+EnQmY4/Ml10FbXfQ0lfh54Ovug6TZxaJ4cCK5lBwjEj0QzRzwOX5O0py2o9BJvZiAB3RkwZwysdH0t3GO134D+NJ6uoDWXpKr6qyjb2XYGMTTIbdJIEtcyAhLFiPF11T7Rn8cw/jrpIxb5Bg9SLRDAKXTTxbPMHocNnwQL6Fjp5wtDSIai7s7H9la5Lq16M6tWGW/gzOw2GCc2YmWgbStLJ7XAF29QRRpvIy6wH5wLVu73JcQDdJtJ3aivhiS4CiwbWnS1Mpr2BicWvgBoYafJRpitC7yfAEthi1PMY5vFNou9lQyDKtnBRu+PGym5p4Cn4eD4N7J0IiipzhD3u3IL+kbt9NZQVoLsN/2CoU9vKm717QHfimXLckAmM9Gt9YNOiJ0= {{ .chezmoi.group }}@ArchLinux'

# 初始化脚本：
function init() {
  if(`curl -s "https://api.ip.sb/geoip" | grep -oP '(?<=country_code":")\w+'` = 'CN') {
    _DISABLE_CLOUDFALRE_FOR_CN='#'
  }
  case `ps -p $$ --no-headers -o comm` in
    sh)
      printf '\033[31;1mSorry, "sh" is not suppot, please use bash or zsh.\033[0m\n'
      exit 1;
      ;;
    bash)
      _SCRIPT_FILENAME=${BASH_SOURCE[0]}
      ;;
    zsh)
      _SCRIPT_FILENAME=${0}
      ;;
    fish)
      # 有生之年可能会适配，主要是 fish 语法太傻逼了。。。
      _SCRIPT_FILENAME=${0}
      ;;
    *)
      _SCRIPT_FILENAME=`ps -p $$ --no-headers -o comm`sh
  esac
}

function auto_tools_help() {
  printf ' \033[31;1mYou can execute the following command.\033[0m\n'
  printf '   \033[32;1mauto_tools_help\033[0m\n'
  printf '   \033[32;1mauto_conf_locale\033[0m\n'
  printf '   \033[32;1mauto_conf_env\033[0m\n'
  printf '   \033[32;1mauto_conf_net\033[0m\n'
  printf '   \033[32;1mauto_conf_iptable\033[0m\n'
  printf '   \033[32;1mauto_conf_pacman\033[0m\n'
  printf '   \033[32;1mauto_conf_sshd\033[0m\n'
  printf '   \033[32;1mauto_conf_shell\033[0m\n'
  printf '   \033[32;1mauto_conf_utility_software\033[0m\n'
  printf '   \033[32;1mauto_conf_bootloader\033[0m\n'
  printf '   \033[32;1mauto_conf_vps2arch\033[0m\n'
  printf '   \033[32;1mauto_install_{{ .chezmoi.osRelease.id }}\033[0m\n'
  if [[ ! ${_SCRIPT_LOAD} ]]; then
    printf ' \033[31;1mIf"command not found" occurs, please start the script with the following command\033[0m\n'
    printf "   \033[32;1m\". ${_SCRIPT_FILENAME}\" or \"source ${_SCRIPT_FILENAME}\"\033[0m\n"
  fi
}

function auto_conf_locale() {
  timedatectl set-timezone ${_TIMEZONE}
  timedatectl set-ntp true
  hwclock --systohc
  sed -i 's/#en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen
  sed -i 's/#zh_CN.UTF-8 UTF-8/zh_CN.UTF-8 UTF-8/' /etc/locale.gen
  if [[ ${_LANG} != 'en_US.UTF-8' && ${_LANG} != 'zh_CN.UTF-8' ]]; then
    sed -i "s/#${_LANG} UTF-8/${_LANG} UTF-8/" /etc/locale.gen
  fi
  echo "LANG=${_LANG}" > /etc/locale.conf
}

function auto_conf_env() {
  if [[ ! -d ${HOME}/.local/state/${_SHELL}/history ]]; then
    mkdir -p ${HOME}/.local/state/${_SHELL}/history
  fi

  cat > ${HOME}/.pam_environment <<-EOF
    XDG_CACHE_HOME  DEFAULT=@{HOME}/.cache
    XDG_CONFIG_HOME DEFAULT=@{HOME}/.config
    XDG_DATA_HOME   DEFAULT=@{HOME}/.local/share
    XDG_STATE_HOME  DEFAULT=@{HOME}/.local/state
    XDG_DATA_DIRS   DEFAULT=/usr/local/share:/usr/share
    XDG_CONFIG_DIRS DEFAULT=/etc/xdg

    HISTFILE        DEFAULT=\${XDG_STATE_HOME}/${_SHELL}/history
    GNUPGHOME       DEFAULT=\${XDG_DATA_HOME}/gnupg
    VSCODE_PORTABLE DEFAULT=\${XDG_DATA_HOME}/vscode

    EDITOR          DEFAULT=${_EDITOR}
    VISUAL          DEFAULT=${_EDITOR}
    SUDO_EDITOR     DEFAULT=${_EDITOR}
	EOF
  # Prevent the unavailability of environment variables caused by not restarting the terminal
  export GNUPGHOME=${HOME}/.local/share/gnupg
  if [[ -d ${HOME}/.gnupg ]]; then
    rm ${HOME}/.gnupg
  fi
}

function auto_conf_net() {
  # 这行代码是从 vps2arch 那里抄过来的. 感谢 vps2arch 的作者！
  # Black Magic!

	local gateway dev

	read -r dev gateway <<-EOF
		`awk '$2 == "00000000" {
      ip = strtonum(sprintf("0x%s", $3));
		  printf ("%s\t%d.%d.%d.%d", $1,
		    rshift(and(ip,0x000000ff),00), rshift(and(ip,0x0000ff00),08),
		    rshift(and(ip,0x00ff0000),16), rshift(and(ip,0xff000000),24));
      exit;
    }' < /proc/net/route`
	EOF

	cat > /etc/systemd/network/10-default.link <<-EOF
		[Match]
		MACAddress=`cat /sys/class/net/${dev}/address`

		[Link]
		Name=${dev}
	EOF
	cat > /etc/systemd/network/default.network <<-EOF
		[Match]
		Name=${dev}

		[Network]
		Gateway=${gateway}
	EOF
	echo "Address=`ip addr show dev ${dev} | awk '($1 == "inet") { print $2 }'`" >> /etc/systemd/network/default.network

	systemctl enable systemd-networkd
}

function auto_conf_dns() {
  cat > /etc/hosts <<-EOF
		::1             localhost
		127.0.0.1       localhost
	EOF
  echo ${_HOSTNAME} > /etc/hostname

  systemctl disable systemd-resolved
  if [[ ${_DNS_OVER_HTTPS} ]]; then
    if ! [[ ${_DNS_SERVER_M} && ${_DNS_SERVER_B} ]]; then
      if [[ ${_DNS_SERVER_M} ]]; then
        _DNS_SERVER_B=${_DNS_SERVER_M}
      else
        _DNS_SERVER_M='8.8.8.8'
        if [[ ! ${_DNS_SERVER_B} ]]; then
          _DNS_SERVER_B=${_DNS_SERVER_M}
        fi
      fi
    fi
    cat > /etc/resolv.conf <<-EOF
		  nameserver ::1
		  nameserver 127.0.0.1
      options edns0 single-request-reopen
		EOF
    cat > /etc/dns-over-https/doh-client.conf <<-EOF
		  listen = [
        "127.0.0.1:53",
        "[::1]:53",
      ]

      [upstream]
        upstream_selector = "weighted_round_robin"

      [[upstream.upstream_ietf]]
        url = "${_DNS_OVER_HTTPS}"
        weight = 100

      [others]
      bootstrap = [
        "${_DNS_SERVER_M}",
        "${_DNS_SERVER_B}",
      ]

      passthrough = [
        "0.{{ .chezmoi.osRelease.id }}.pool.ntp.org",
      ]

      timeout = 30
      no_cookies = true
      no_ecs = false
      no_ipv6 = false
      no_user_agent = false
      verbose = true
      insecure_tls_skip_verify = false
		EOF
    systemctl enable doh-client.service
  else
    if ! [[ ${_DNS_SERVER_M} && ${_DNS_SERVER_B} ]]; then
      if [[ ${_DNS_SERVER_M} ]]; then
        echo "nameserver $_DNS_SERVER_M" > /etc/resolv.conf
      else
        if [[ ${_DNS_SERVER_B} ]]; then
          echo "nameserver $_DNS_SERVER_B" > /etc/resolv.conf
        else
          echo 'nameserver 8.8.8.8' > /etc/resolv.conf
        fi
      fi
    fi
  fi
}

function auto_conf_iptable() {
  iptables  -F
  ip6tables -F

  iptables  -P INPUT DROP
  ip6tables -P INPUT DROP
  iptables  -P FORWARD DROP
  ip6tables -P FORWARD DROP
  iptables  -P OUTPUT ACCEPT
  ip6tables -P OUTPUT ACCEPT

  iptables  -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
  ip6tables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

  iptables-save  > /etc/iptables/iptables.rules
  ip6tables-save > /etc/iptables/ip6tables.rules

  systemctl enable iptables
  systemctl enable ip6tables
}

function auto_conf_pacman() {
  if [[ ! -f '/etc/pacman.d/mirrorlist-cn' ]]; then
    cat > /etc/pacman.d/mirrorlist <<-EOF
      `_DISABLE_CLOUDFALRE_FOR_CN`Server = https://cloudflaremirrors.com/archlinux/\$repo/os/\${{ .chezmoi.osRelease.id }}
      Server = https://mirrors.bfsu.edu.cn/archlinux/\$repo/os/\${{ .chezmoi.osRelease.id }}
      Server = https://mirrors.neusoft.edu.cn/archlinux/\$repo/os/\${{ .chezmoi.osRelease.id }}
      Server = https://mirrors.tuna.tsinghua.edu.cn/archlinux/\$repo/os/\${{ .chezmoi.osRelease.id }}
		EOF

    cat > /etc/pacman.d/mirrorlist-cn <<-EOF
      Server = https://mirrors.bfsu.edu.cn/archlinuxcn/\${{ .chezmoi.osRelease.id }}
      Server = https://mirrors.tuna.tsinghua.edu.cn/archlinuxcn/\${{ .chezmoi.osRelease.id }}
		EOF

    sed -i 's/#UseSyslog/UseSyslog/' /etc/pacman.conf
    sed -i 's/#Color/Color/' /etc/pacman.conf
    sed -i 's/#VerbosePkgLists/VerbosePkgLists/' /etc/pacman.conf
    sed -i 's/#ParallelDownloads/ParallelDownloads/' /etc/pacman.conf

    if [[ -f '/version' ]]; then
      pacman-key --init && pacman-key --populate archlinux
    else
      cat >> /etc/pacman.conf <<-EOF
        [archlinuxcn]
        Include = /etc/pacman.d/mirrorlist-cn

        #[zhullyb]
        #Server = https://pkg.web-worker.cn/zhullyb

        #[web-worker]
        #Server = https://pkg.web-worker.cn/archlinux
			EOF
      pacman --noconfirm -Sy archlinuxcn-keyring
    fi
  else
    sed -i 's/#\[zhullyb\]/\[zhullyb\]/' /etc/pacman.conf
    sed -i 's|#Server = https://pkg.web-worker.cn/zhullyb|Server = https://pkg.web-worker.cn/zhullyb|' /etc/pacman.conf
    pacman --noconfirm -S zhullyb-keyring #web-worker-keyring
    pacman-key --lsign-key zhullyb
  fi
}

function auto_conf_sshd() {
  iptables  -A INPUT -p tcp --dport 22 -j ACCEPT
  ip6tables -A INPUT -p tcp --dport 22 -j ACCEPT
  iptables-save  > /etc/iptables/iptables.rules
  ip6tables-save > /etc/iptables/ip6tables.rules

  if [[ ! -x `command -v ssh` ]]; then
    pacman --noconfirm -S openssh
  fi

  if [[ ${_ROOT_PASSWORD} ]]; then
    echo root:${_ROOT_PASSWORD}|chpasswd
  fi

  if [[ ! -d ${HOME}/.ssh ]]; then
    install -D -m 700 -o root -g root -d ${HOME}/.ssh
  fi
  echo ${_SSH_PUBKEY} > ${HOME}/.ssh/authorized_keys

  # Allow Pubkey Authentication
  sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config
  if [[ ${_PASSWORD_LOGIN} = "ENABLE" ]]; then
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
  else
    # Forbid Password Authentication
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin prohibit-password/' /etc/ssh/sshd_config
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
  fi
  # 防止长时间无操作会话断开
  sed -i 's/#ClientAliveInterval 0/ClientAliveInterval 60/' /etc/ssh/sshd_config
  # Forwarding
  sed -i 's/#AllowAgentForwarding yes/AllowAgentForwarding yes/' /etc/ssh/sshd_config
  sed -i 's/#AllowTcpForwarding yes/AllowAgentForwarding yes/' /etc/ssh/sshd_config
  sed -i 's/#X11Forwarding no/X11Forwarding yes/' /etc/ssh/sshd_config
  sed -i 's/#X11DisplayOffset 10/X11DisplayOffset 10/' /etc/ssh/sshd_config
  sed -i 's/#X11UseLocalhost yes/X11UseLocalhost yes/' /etc/ssh/sshd_config
  echo 'StreamLocalBindUnlink yes' >> /etc/ssh/sshd_config

  systemctl enable sshd
}

function auto_conf_shell() {
  case ${_SHELL} in
    zsh)
      pacman --noconfirm -S zsh oh-my-zsh-git zsh-autosuggestions zsh-syntax-highlighting
      ln -sf /usr/share/zsh/plugins/zsh-autosuggestions/ /usr/share/oh-my-zsh/plugins/
      ln -sf /usr/share/zsh/plugins/zsh-syntax-highlighting/ /usr/share/oh-my-zsh/plugins/
      cat > ${HOME}/.zshrc <<-EOF
        # Setting zsh cache.
        ZSH_CACHE_DIR=\${HOME}/.cache/zsh
        if [[ ! -d \${ZSH_CACHE_DIR} ]]; then
          mkdir \${ZSH_CACHE_DIR}
        fi
        # Setting zsh comdump.
        ZSH_COMPDUMP=\${XDG_CACHE_HOME}/zsh/zcompdump-\${SHORT_HOST}-\${ZSH_VERSION}

        # Setting zsh config.
        ZSH="/usr/share/oh-my-zsh/"
        ZSH_THEME="gnzh"
        plugins=(sudo zsh-syntax-highlighting zsh-autosuggestions vscode)
        DISABLE_AUTO_UPDATE="true"
        source \${ZSH}/oh-my-zsh.sh
			EOF
      chsh -s /bin/zsh
      ;;
  # TODO BASH FISH 支持
    bash)
      ;;
    fish)
      # 有生之年可能会适配，主要是 fish 语法太傻逼了。。。
      ;;
    *)
      printf '\033[31;1mSorry, '${_SHELL}' is not suppot, please use bash or zsh.\033[0m\n'
  esac
}

function auto_conf_utility_software() {
  pacman --noconfirm -S htop git gpg ${_EDITOR}
  if [[ -d ../.config ]]; then
    cp -r ../.config ${HOME}/
  fi
}

function auto_conf_bootloader() {
  if [[ ! -d /sys/firmware/efi/efivars ]]; then
    if [[ ! -x `command -v grub-install` ]]; then
      pacman --noconfirm -S grub
    fi
    grub-install --target=i386-pc --recheck --force /dev/`cat /proc/diskstats | awk '{print $3}' | grep '[a-z]d[a-z]' | grep -v '[0-9]' | head -n 1`
    grub-mkconfig -o /boot/grub/grub.cfg
  fi
}

function auto_conf_vps2arch() {
  # Stop, Disable And Remove Reflector.
  systemctl disable --now reflector
  pacman --noconfirm -Rsn reflector

  # Remove lvm2.
  pacman --noconfirm -Rsn lvm2

  # Remove {{ .chezmoi.os }} kernel, and Install {{ .chezmoi.os }}-zen kernel.
  pacman --noconfirm -Rsn {{ .chezmoi.os }}
  pacman --noconfirm -S {{ .chezmoi.os }}-zen
  auto_conf_bootloader
}

function auto_install_{{ .chezmoi.osRelease.id }}_create_user() {
  pacman --noconfirm -S sudo
  sed -i 's/# %wheel ALL=(ALL) ALL/%wheel ALL=(ALL) ALL/' /etc/sudoers

  useradd ${_USER_NAME} -m -G wheel
  if [[ ${_USER_PASSWORD} ]]; then
    echo ${_USER_NAME}:${_USER_PASSWORD}|chpasswd
  fi

  if [[ ! -d /home/${_USER_NAME}/.ssh ]]; then
    install -D -m 700 -o ${_USER_NAME} -g wheel -d /home/${_USER_NAME}/.ssh
  fi
  echo ${_SSH_PUBKEY} > /home/${_USER_NAME}/.ssh/authorized_keys

  install -D -m 600 -o ${_USER_NAME} -g wheel ${HOME}/.pam_environment /home/${_USER_NAME}/.pam_environment
  install -D -m 700 -o ${_USER_NAME} -g wheel ${HOME}/.zshrc /home/${_USER_NAME}/.zshrc
  chsh -s /bin/zsh

  if [[ -d ../.config ]]; then
    cp -r ../.config ${HOME}/
  fi
}

function chroot_exec() {

}

function auto_install_{{ .chezmoi.osRelease.id }}_p1() {
  # TODO 此处代重构
  local rootfs_path base_url rootfs_url sha256sums_url

  rootfs_path=/tmp/{{ .chezmoi.osRelease.id }}-rootfs

  if [[ ! -d ${rootfs_path} ]]; then
    mkdir -p ${rootfs_path}
  fi

  if [[ -x `command -v wget` ]]; then
    rootfs_url=${base_url}`wget -q -O - ${base_url} | grep -o '[0-9].*/"' | tail -n1 | sed -e 's/"//'`rootfs.tar.xz
    sha256sums_url=${base_url}`wget -q -O - ${base_url} | grep -o '[0-9].*/"' | tail -n1 | sed -e 's/"//'`SHA256SUMS
  	wget -q --show-progress ${rootfs_url}
    wget -q --show-progress ${sha256sums_url}
  elif [[ -x `command -v curl` ]]; then
    rootfs_url=${base_url}`curl -s ${base_url} | grep -o '[0-9].*/"' | tail -n1 | sed -e 's/"//'`rootfs.tar.xz
    sha256sums_url=${base_url}`curl -s ${base_url} | grep -o '[0-9].*/"' | tail -n1 | sed -e 's/"//'`SHA256SUMS
  	curl -fLO ${rootfs_url}
    curl -fLO ${sha256sums_url}
  else
	  echo "This script needs wget or curl." >&2
	  exit 2
  fi

  echo `cat SHA256SUMS | awk '$2 == "rootfs.tar.xz"'` > SHA256SUMS
  sha256sum -c SHA256SUMS > /dev/null
  if [[ $? != 0 ]]; then
    rm rootfs.tar.xz SHA256SUMS
    auto_install_{{ .chezmoi.osRelease.id }}_p1
  fi

  tar xf rootfs.tar.xz -C ${rootfs_path}
  mount --bind ${rootfs_path} ${rootfs_path}

  install -D -m 755 -o root -g root ${_SCRIPT_FILENAME} ${rootfs_path}/${_SCRIPT_FILENAME}
  echo "_SCRIPT_FILENAME_STATIC=${_SCRIPT_FILENAME}" >> ${rootfs_path}/${_SCRIPT_FILENAME}
  echo 'auto_install_{{ .chezmoi.osRelease.id }}' >> ${rootfs_path}/${_SCRIPT_FILENAME}
  ${rootfs_path}/bin/{{ .chezmoi.osRelease.id }}-chroot ${rootfs_path} /${_SCRIPT_FILENAME}
}

function auto_install_{{ .chezmoi.osRelease.id }}_p2() {
  local mount_path

  mount_path='/mnt'

  mount `df -h / | awk '$6 == "/" {print $1}'` ${mount_path}
  rm -rf `find ${mount_path} -maxdepth 1 | grep -E -v "(dev|proc|run|sys|tmp)" | awk 'NR!=1 {print}' | sort`
  auto_conf_pacman
  pacstrap ${mount_path} base base-devel {{ .chezmoi.os }}-zen
  genfstab -U ${mount_path} >> ${mount_path}/etc/fstab
  rm ${mount_path}/etc/resolv.conf
  install -D -m 755 -o root -g root /${_SCRIPT_FILENAME_STATIC} ${mount_path}/${_SCRIPT_FILENAME_STATIC}
  {{ .chezmoi.osRelease.id }}-chroot ${mount_path} /${_SCRIPT_FILENAME_STATIC}
}

function auto_install_{{ .chezmoi.osRelease.id }}_p3() {
  auto_conf_net
  auto_conf_dns
  auto_conf_sshd
  auto_conf_bootloader

  sed -i '$d' /${_SCRIPT_FILENAME_STATIC}
  sed -i '$d' /${_SCRIPT_FILENAME_STATIC}
  mv /${_SCRIPT_FILENAME_STATIC} /root/${_SCRIPT_FILENAME_STATIC}
  echo 'auto_install_{{ .chezmoi.osRelease.id }}_p4' >> /root/${_SCRIPT_FILENAME_STATIC}
  echo "source /root/${_SCRIPT_FILENAME_STATIC}" > /root/.bashrc
  sync
  reboot
}

function auto_install_{{ .chezmoi.osRelease.id }}_p4() {
  auto_conf_locale
  auto_conf_iptable
  auto_conf_sshd
  auto_conf_pacman
  auto_conf_env
  auto_conf_shell
  auto_conf_utility_software

  if [[ ${_USER_NAME} ]]; then
    auto_install_{{ .chezmoi.osRelease.id }}_create_user
  fi

  sed -i '$d' /root/${_SCRIPT_FILENAME_STATIC}
}

function auto_install_{{ .chezmoi.osRelease.id }}() {
  if [[ `cat /etc/*-release | grep -E -w 'ID=.*' | awk -F '=' '{print $2}'` != '{{ .chezmoi.osRelease.id }}' ]]; then
    auto_install_{{ .chezmoi.osRelease.id }}_p1
  else
    if [[ -f '/version' ]]; then
      auto_install_{{ .chezmoi.osRelease.id }}_p2
    else
      auto_install_{{ .chezmoi.osRelease.id }}_p3
    fi
  fi
}

init
# If auto_conf_{{ .chezmoi.osRelease.id }} is not loaded, will execute following code.
if [[ ! -f '/version' ]]; then
  if [[ ! ${_SCRIPT_LOAD} ]]; then
    auto_tools_help
    _SCRIPT_LOAD='\033[31;1mThis script is load, you can use\033[0m \033[32;1mauto_tools_help\033[0m \033[31;1mto get help.\033[0m\n'
  else
    printf "${_SCRIPT_LOAD}"
  fi
fi

# HACK: Maybe you need install App: axel zip unzip neofetch v2ray php php-fpm php-sqlite nginx-mainline certbot-nginx goaccess
# HACK: 对接 Tencent Cloud SDK
# ip(6)table: Tencent Cloud SDK
  #iptables  -A INPUT -p tcp --dport 80 -j ACCEPT
  #ip6tables -A INPUT -p tcp --dport 80 -j ACCEPT
  #iptables  -A INPUT -p tcp --dport 443 -j ACCEPT
  #ip6tables -A INPUT -p tcp --dport 443 -j ACCEPT
